<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Image Segmentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .slice-viewer {
            max-width: 800px;
            max-height: 600px;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">AI-Powered Medical Image Segmentation</h1>
            <p class="text-gray-600">Upload medical images for automated tumor and organ segmentation</p>
            <div id="status" class="mt-4">
                <span id="health-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                    Checking system status...
                </span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Medical Image</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="upload-area">
                <input type="file" id="file-input" accept=".nii,.nii.gz,.dcm,.mha,.mhd" class="hidden">
                <div id="upload-content">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="text-gray-600 mb-2">Click to upload or drag and drop</p>
                    <p class="text-sm text-gray-500">Supported formats: .nii, .nii.gz, .dcm, .mha, .mhd</p>
                </div>
                <div id="upload-progress" class="hidden">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-600">Uploading...</p>
                </div>
            </div>
            <button id="upload-btn" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                Upload Image
            </button>
        </div>

        <!-- Image Info Section -->
        <div id="image-info" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Image Information</h2>
            <div id="image-details" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <button id="predict-btn" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Run Segmentation
            </button>
        </div>

        <!-- Prediction Progress -->
        <div id="prediction-progress" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <div class="flex items-center justify-center">
                <div class="loader mr-4"></div>
                <div>
                    <h3 class="text-lg font-semibold">Processing Image...</h3>
                    <p class="text-gray-600">This may take a few minutes depending on image size</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4">Segmentation Results</h2>
            
            <!-- Metrics -->
            <div id="metrics" class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Performance Metrics</h3>
                <div id="metrics-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Visualization Controls -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Visualization</h3>
                <div class="flex flex-wrap gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">View</label>
                        <select id="axis-select" class="border border-gray-300 rounded-md px-3 py-2">
                            <option value="axial">Axial</option>
                            <option value="sagittal">Sagittal</option>
                            <option value="coronal">Coronal</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Slice</label>
                        <input type="range" id="slice-slider" class="w-32" min="0" max="100" value="50">
                        <span id="slice-info" class="ml-2 text-sm text-gray-600">50/100</span>
                    </div>
                </div>
            </div>

            <!-- Image Viewer -->
            <div class="slice-viewer bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                <img id="slice-image" class="mx-auto max-w-full h-auto" alt="Medical image slice">
                <p id="loading-slice" class="text-center text-gray-500 hidden">Loading slice...</p>
            </div>

            <!-- Download Section -->
            <div class="flex flex-wrap gap-4">
                <button id="download-original" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    Download Original
                </button>
                <button id="download-prediction" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    Download Segmentation
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-sm">
            <p>AI-Powered Medical Image Segmentation System</p>
            <p>Developed for healthcare applications with U-Net and Vision Transformer architectures</p>
        </div>
    </div>

    <script>
        let currentFileId = null;
        let visualizationData = null;

        // Check system health on load
        window.addEventListener('load', checkSystemHealth);

        async function checkSystemHealth() {
            try {
                const response = await axios.get('/api/health');
                const status = response.data;
                const statusElement = document.getElementById('health-status');
                
                if (status.predictor_loaded) {
                    statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                    statusElement.textContent = `System Ready (${status.model_type.toUpperCase()} Model)`;
                } else {
                    statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
                    statusElement.textContent = 'Model Not Loaded - Limited Functionality';
                }
            } catch (error) {
                const statusElement = document.getElementById('health-status');
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                statusElement.textContent = 'System Error';
            }
        }

        // File upload handling
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const uploadBtn = document.getElementById('upload-btn');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-500');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-blue-500');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                uploadBtn.disabled = false;
                document.getElementById('upload-content').innerHTML = `
                    <p class="text-gray-600">${file.name}</p>
                    <p class="text-sm text-gray-500">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
            }
        }

        uploadBtn.addEventListener('click', uploadFile);

        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            showUploadProgress();

            try {
                const response = await axios.post('/api/upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });

                const data = response.data;
                currentFileId = data.file_id;
                showImageInfo(data);
                hideUploadProgress();
            } catch (error) {
                hideUploadProgress();
                showError('Upload failed: ' + (error.response?.data?.error || error.message));
            }
        }

        function showUploadProgress() {
            document.getElementById('upload-content').classList.add('hidden');
            document.getElementById('upload-progress').classList.remove('hidden');
            uploadBtn.disabled = true;
        }

        function hideUploadProgress() {
            document.getElementById('upload-content').classList.remove('hidden');
            document.getElementById('upload-progress').classList.add('hidden');
            uploadBtn.disabled = false;
        }

        function showImageInfo(data) {
            const imageInfo = document.getElementById('image-info');
            const imageDetails = document.getElementById('image-details');
            
            imageDetails.innerHTML = `
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold">Dimensions</h4>
                    <p>${data.image_info.shape.join(' × ')} voxels</p>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold">Spacing</h4>
                    <p>${data.image_info.spacing.map(s => s.toFixed(2)).join(' × ')} mm</p>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold">Intensity Range</h4>
                    <p>${data.image_info.min_value.toFixed(1)} - ${data.image_info.max_value.toFixed(1)}</p>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold">Data Type</h4>
                    <p>${data.image_info.dtype}</p>
                </div>
            `;
            
            imageInfo.classList.remove('hidden');
        }

        // Prediction handling
        document.getElementById('predict-btn').addEventListener('click', runPrediction);

        async function runPrediction() {
            if (!currentFileId) return;

            document.getElementById('prediction-progress').classList.remove('hidden');
            document.getElementById('predict-btn').disabled = true;

            try {
                const response = await axios.post('/api/predict', {
                    file_id: currentFileId
                });

                const data = response.data;
                showResults(data);
                document.getElementById('prediction-progress').classList.add('hidden');
            } catch (error) {
                document.getElementById('prediction-progress').classList.add('hidden');
                document.getElementById('predict-btn').disabled = false;
                showError('Prediction failed: ' + (error.response?.data?.error || error.message));
            }
        }

        function showResults(data) {
            visualizationData = data.visualizations;
            
            // Show metrics
            const metricsGrid = document.getElementById('metrics-grid');
            metricsGrid.innerHTML = `
                <div class="bg-green-50 p-3 rounded">
                    <h4 class="font-semibold text-green-800">Processing Time</h4>
                    <p class="text-green-600">${data.processing_time.toFixed(2)} seconds</p>
                </div>
                <div class="bg-blue-50 p-3 rounded">
                    <h4 class="font-semibold text-blue-800">Status</h4>
                    <p class="text-blue-600">Completed Successfully</p>
                </div>
                <div class="bg-purple-50 p-3 rounded">
                    <h4 class="font-semibold text-purple-800">Model</h4>
                    <p class="text-purple-600">3D Segmentation</p>
                </div>
            `;

            // Setup slice viewer
            setupSliceViewer();
            
            // Setup download buttons
            setupDownloadButtons();

            document.getElementById('results').classList.remove('hidden');
        }

        function setupSliceViewer() {
            const axisSelect = document.getElementById('axis-select');
            const sliceSlider = document.getElementById('slice-slider');
            const sliceInfo = document.getElementById('slice-info');

            // Set initial values
            updateSliceControls();
            loadSliceImage();

            axisSelect.addEventListener('change', () => {
                updateSliceControls();
                loadSliceImage();
            });

            sliceSlider.addEventListener('input', () => {
                updateSliceInfo();
                loadSliceImage();
            });
        }

        function updateSliceControls() {
            const axis = document.getElementById('axis-select').value;
            const sliceSlider = document.getElementById('slice-slider');
            
            if (visualizationData) {
                const maxSlices = visualizationData.slice_counts[axis];
                const bestSlice = visualizationData.best_slices[axis];
                
                sliceSlider.max = maxSlices - 1;
                sliceSlider.value = bestSlice;
                updateSliceInfo();
            }
        }

        function updateSliceInfo() {
            const sliceSlider = document.getElementById('slice-slider');
            const sliceInfo = document.getElementById('slice-info');
            const current = parseInt(sliceSlider.value) + 1;
            const total = parseInt(sliceSlider.max) + 1;
            sliceInfo.textContent = `${current}/${total}`;
        }

        async function loadSliceImage() {
            if (!currentFileId || !visualizationData) return;

            const axis = document.getElementById('axis-select').value;
            const sliceIdx = document.getElementById('slice-slider').value;
            const sliceImage = document.getElementById('slice-image');
            const loadingSlice = document.getElementById('loading-slice');

            sliceImage.classList.add('hidden');
            loadingSlice.classList.remove('hidden');

            try {
                const response = await axios.get(`/api/slice/${currentFileId}/${sliceIdx}/${axis}`, {
                    responseType: 'blob'
                });

                const imageUrl = URL.createObjectURL(response.data);
                sliceImage.src = imageUrl;
                sliceImage.onload = () => {
                    sliceImage.classList.remove('hidden');
                    loadingSlice.classList.add('hidden');
                };
            } catch (error) {
                loadingSlice.textContent = 'Error loading slice';
                console.error('Error loading slice:', error);
            }
        }

        function setupDownloadButtons() {
            document.getElementById('download-original').addEventListener('click', () => {
                downloadFile('original');
            });

            document.getElementById('download-prediction').addEventListener('click', () => {
                downloadFile('prediction');
            });
        }

        function downloadFile(fileType) {
            if (!currentFileId) return;
            
            const url = `/api/download/${currentFileId}/${fileType}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showError(message) {
            alert(message); // Simple error handling - could be improved with better UI
        }
    </script>
</body>
</html>